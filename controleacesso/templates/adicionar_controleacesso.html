{% extends 'base_login.html' %}
{% load static %}

{% block menu %}
<!-- Código do menu permanece o mesmo -->
{% endblock %}

{% block content %}
<br>
<h2 style="text-align: center;">Adicionar Controle de Acesso</h2>

<div class="container">
    <form method="POST">
        {% csrf_token %}

        <input type="hidden" name="status" value="1">

        <div class="row">
            <!-- Primeira coluna -->
            <div class="col-md-6">
                <label for="colaborador"><strong>Colaborador:</strong></label>
                <select id="colaborador" name="colaborador" class="form-control">
                    <option value="">Selecione um Colaborador</option>
                    {% for colaborador in colaboradores %}
                        <option value="{{ colaborador.id }}">{{ colaborador.nome_funcionario }}</option>
                    {% endfor %}
                </select>

                <label for="tipos_controles_acesso"><strong>Tipos de Controle de Acesso:</strong></label>
                <select id="tipos_controles_acesso" name="tipos_controles_acesso" class="form-control">
                    <option value="">Selecione...</option>
                    {% for tipo in tipos_controles_acesso %}
                        <option value="{{ tipo.id }}">{{ tipo.nome_tipos_controles_acesso }}</option>
                    {% endfor %}
                </select>

                <label for="perfil_solicitante"><strong>Perfil Do Solicitante:</strong></label>
                <select id="perfil_solicitante" name="perfil_solicitante" class="form-control">
                    <option value="">Selecione um perfil</option>
                    <option value="morador">Morador</option>
                    <option value="sindico">Síndico</option>
                    <option value="funcionario_condominio">Funcionário do Condomínio</option>
                    <option value="outros">Outros</option>
                </select>

                <label for="condominio"><strong>Condomínio:</strong></label>
                <select id="condominio" name="condominio" class="form-control">
                    <option value="">Selecione um Condomínio</option>
                    {% for condominio in condominios %}
                        <option value="{{ condominio.id }}">{{ condominio.nome_condominio }}</option>
                    {% endfor %}
                </select>

                <label for="apartamento" class="form-label">Apartamento:</label>
                <select name="apartamento" id="apartamento" class="form-control" required>
                    <option value="">Selecione o Apartamento...</option>
                </select>

                <label for="pessoa" class="form-label">Pessoa:</label>
                <select id="pessoa" name="pessoa" class="form-control">
                    <option value="">Selecione a Pessoa...</option>
                </select>
            </div>

            <!-- Segunda coluna -->
            <div class="col-md-6">
                <label for="execucao"><strong>Execução:</strong></label>
                <select id="execucao" name="execucao" class="form-control">
                    <option value="1">Remoto</option>
                    <option value="2">Presencial</option>
                </select>

                <label for="pedido"><strong>Pedido:</strong></label>
                <select id="pedido" name="pedido" class="form-control" required>
                    <option value="" disabled selected>Selecione...</option>
                    <option value="1">Gratuito</option>
                    <option value="2">Aguardando Pagamento</option>
                    <option value="3">Pago em dinheiro</option>
                    <option value="4">Pago por transferência</option>
                </select>

                <label for="quantidade"><strong>Quantidade:</strong></label>
                <input type="number" id="quantidade" name="quantidade" class="form-control" min="1" />

                <label for="descricao"><strong>Descrição para o Cliente:</strong></label>
                <textarea id="descricao" name="descricao" class="form-control"></textarea>

                <label for="valor"><strong>Valor:</strong></label>
                <input id="valor" name="valor" type="text" class="form-control" placeholder="Digite o valor">
            </div>
        </div>

        <div class="form-group"><br>
            <button type="submit" class="btn btn-primary">Salvar Controle de Acesso</button>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
    // Máscaras
    $(document).ready(function() {
        $('#valor').mask('000.000.000,00', {reverse: true});
    });

function atualizarApartamentosEUsuarios(condominioId, perfilSolicitante) {
    let apartamentoSelect = document.getElementById('apartamento');
    let pessoaSelect = document.getElementById('pessoa');

    // Limpar o conteúdo atual dos selects
    pessoaSelect.innerHTML = '<option value="">Selecione a Pessoa...</option>';
    apartamentoSelect.innerHTML = '<option value="">Selecione o Apartamento...</option>';

    if (condominioId) {
        // Carregar apartamentos
        fetch("{% url 'get_apartamentos_por_condominio' %}?condominio_id=" + condominioId)
            .then(response => response.json())
            .then(data => {
                data.apartamentos.forEach(function(apartamento) {
                    let option = document.createElement('option');
                    option.value = apartamento.id;
                    option.text = apartamento.nome_apartamento;
                    apartamentoSelect.appendChild(option);
                });

                // Se o perfil for "síndico", então deve buscar também as pessoas associadas
                if (perfilSolicitante === "sindico") {
                    fetch("{% url 'get_apartamento_sindico' %}?condominio_id=" + condominioId)
                        .then(response => response.json())
                        .then(data => {
                            // Limpar dropdown de pessoas antes de adicionar novas opções
                            pessoaSelect.innerHTML = '<option value="">Selecione a Pessoa...</option>';

                            // Adiciona os apartamentos do síndico (se necessário)
                            apartamentoSelect.innerHTML = '<option value="">Selecione o Apartamento...</option>';
                            data.sindicos.forEach(function(sindico) {
                                let option = document.createElement('option');
                                option.value = sindico.apartamento_nome; // Atribuindo o nome do apartamento
                                option.text = sindico.apartamento_nome; // Nome do apartamento
                                apartamentoSelect.appendChild(option);
                            });

                            // Adiciona as pessoas ao dropdown de pessoas
                            data.sindicos.forEach(function(sindico) {
                                let option = document.createElement('option');
                                option.value = sindico.pessoa_nome;  // Adicionando o nome da pessoa
                                option.text = sindico.pessoa_nome + ' (' + sindico.pessoa_nome + ')'; // Exibe o nome e tipo da pessoa
                                pessoaSelect.appendChild(option);
                            });
                        })
                        .catch(error => console.error('Erro ao carregar apartamentos e pessoas para síndico:', error));
                }
            })
            .catch(error => console.error('Erro ao carregar apartamentos:', error));
    }
}


function atualizarPessoasPorApartamento(apartamentoId) {
    let pessoaSelect = document.getElementById('pessoa');
    pessoaSelect.innerHTML = '<option value="">Selecione a Pessoa...</option>';

    if (apartamentoId && apartamentoId !== "undefined") {  // Verifica se apartamentoId é válido
        // Carregar pessoas vinculadas ao apartamento
        fetch("{% url 'get_pessoas_por_apartamento' %}?apartamento_id=" + apartamentoId)
            .then(response => response.json())
            .then(data => {
                data.pessoas.forEach(function(pessoa) {
                    let option = document.createElement('option');
                    option.value = pessoa.id;
                    option.text = pessoa.nome_pessoa + ' (' + pessoa.tipo_pessoa + ')';
                    pessoaSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Erro ao carregar pessoas:', error));
    }
}

    // Eventos para atualizar os selects
    document.getElementById('condominio').addEventListener('change', function() {
        let condominioId = this.value;
        atualizarApartamentosEUsuarios(condominioId);
    });

    document.getElementById('apartamento').addEventListener('change', function() {
        let apartamentoId = this.value;
        atualizarPessoasPorApartamento(apartamentoId);
    });
// Eventos
document.getElementById('condominio').addEventListener('change', function() {
    let condominioId = this.value;
    let perfilSolicitante = document.getElementById('perfil_solicitante').value;
    atualizarApartamentosEUsuarios(condominioId, perfilSolicitante);
});

document.getElementById('perfil_solicitante').addEventListener('change', function() {
    let condominioId = document.getElementById('condominio').value;
    atualizarApartamentosEUsuarios(condominioId, this.value);
});

    // Função para alterar os campos dinâmicos baseados no perfil
    $(document).ready(function() {
        const perfilSelect = $('#perfil_solicitante');
        const condominioSelect = $('#condominio');
        const dynamicFields = $('#dynamic_fields');

        perfilSelect.change(function() {
            const perfil = $(this).val();
            const condominioId = condominioSelect.val();

            dynamicFields.empty();

            if (perfil === "sindico" && condominioId) {
                fetch(`/controleacesso/carregar_sindicos/${condominioId}/`)
                    .then(response => response.json())
                    .then(data => {
                        let pessoaField = `<label for="pessoa"><strong>Selecione o Síndico:</strong></label>
                                           <select id="pessoa" name="pessoa" class="form-control">
                                           <option value="">Selecione um Síndico</option>`;
                        data.sindicos.forEach(sindico => {
                            pessoaField += `<option value="${sindico.id}">${sindico.nome}</option>`;
                        });
                        pessoaField += '</select>';
                        dynamicFields.append(pessoaField);
                    });
            } else if (perfil === "morador" && condominioId) {
                fetch(`/controleacesso/carregar_apartamentos/${condominioId}/`)
                    .then(response => response.json())
                    .then(data => {
                        let fields = `
                            <label for="apartamento"><strong>Apartamento:</strong></label>
                            <select id="apartamento" name="apartamento" class="form-control">
                                <option value="">Selecione um Apartamento</option>`;
                        data.apartamentos.forEach(apartamento => {
                            fields += `<option value="${apartamento.id}">${apartamento.nome}</option>`;
                        });
                        fields += '</select>';
                        dynamicFields.append(fields);
                    });
            }
        });
    });
</script>

{% endblock %}
